# ðŸ“Œ VPN Client DockerFile
# ðŸ“¦ Image Alpine avec OpenVPN
FROM alpine:latest

# ðŸ›  Installer OpenVPN et les outils rÃ©seau essentiels
RUN apk add --no-cache \
    sudo \
    openssh \
    net-tools \
    iputils \
    bind-tools \
    jq \
    tcpdump \
    traceroute \
    iproute2 \
    coreutils \
    openvpn \
    bash \
    curl \
    chromium \
    ttf-freefont \
    mesa-dri-gallium \
    mesa-gl \
    mesa-egl \
    xvfb \
    dbus-x11 \
    xauth \
    xdg-utils \
    lxterminal \
    xfce4-terminal \
    adwaita-icon-theme \
    font-noto-emoji

# ðŸ— Ajouter les fichiers skel pour root
COPY skel/ /etc/skel/
RUN cp -r /etc/skel/. /root/

# ðŸ”¹ Mettre Ã  jour les icÃ´nes et polices GTK
RUN gtk-update-icon-cache -f /usr/share/icons/Adwaita

# ðŸ”¹ CrÃ©er un dossier de configuration OpenVPN
RUN mkdir -p /etc/openvpn
# ðŸ“‚ Copie du fichier de configuration VPN
COPY kame.ovpn /etc/openvpn/kame.ovpn
# ðŸ”¹ DÃ©finir les permissions
RUN chmod 600 /etc/openvpn/kame.ovpn

# CrÃ©er l'utilisateur non-root 'kame'
ARG USER=kame
ARG UID=1000

RUN addgroup kame && \
    adduser -D -u 1000 -G kame -s /bin/bash kame && \
    echo "kame ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# RÃ©pertoire home initial
RUN chown -R kame:kame /home/kame

# ðŸŸ¢ DÃ©finir TERM pour activer la couleur
ENV TERM=xterm-256color
# ðŸ”¹ DÃ©finir l'environnement X11
ENV DISPLAY=:0
# âœ… DÃ©sactive les erreurs d'accessibilitÃ©
ENV NO_AT_BRIDGE=1
# âœ… Supprime l'erreur de session manager
ENV SESSION_MANAGER=""


# ðŸƒ ExÃ©cuter OpenVPN au dÃ©marrage
# ðŸ”¹ Script de dÃ©marrage pour X11 + OpenVPN + Chrome
CMD openvpn --config /etc/openvpn/kame.ovpn & \
    sleep 5 && \
    echo -e "nameserver 10.8.0.1\nsearch ryokan.org" > /etc/resolv.conf && \
    sudo -u kame bash -c "tail -f /dev/null"
