# ðŸ“Œ VPN Client DockerFile
# ðŸ“¦ Image Alpine avec OpenVPN
FROM alpine:latest

# ðŸ›  Installer OpenVPN et les outils rÃ©seau essentiels
RUN apk add --no-cache \
    sudo \
    openssh \
    net-tools \
    iputils \
    bind-tools \
    jq \
    tcpdump \
    traceroute \
    iproute2 \
    coreutils \
    openvpn \
    bash \
    curl \
    chromium \
    ttf-freefont \
    mesa-dri-gallium \
    mesa-gl \
    mesa-egl \
    xvfb \
    dbus-x11 \
    xauth \
    xdg-utils \
    lxterminal \
    xfce4-terminal \
    adwaita-icon-theme \
    font-noto-emoji

# ðŸ— Ajouter les fichiers skel pour root
COPY skel/ /etc/skel/
RUN cp -r /etc/skel/. /root/

# ðŸ”¹ Mettre Ã  jour les icÃ´nes et polices GTK
RUN gtk-update-icon-cache -f /usr/share/icons/Adwaita

# ðŸ”¹ CrÃ©er un dossier de configuration OpenVPN
RUN mkdir -p /etc/openvpn
# ðŸ“‚ Copie du fichier de configuration VPN
COPY {{ username }}.ovpn /etc/openvpn/{{ username }}.ovpn
# ðŸ”¹ DÃ©finir les permissions
RUN chmod 600 /etc/openvpn/{{ username }}.ovpn

# CrÃ©er l'utilisateur non-root '{{ username }}'
ARG USER={{ username }}
ARG UID=1000

RUN addgroup {{ username }} && \
    adduser -D -u 1000 -G {{ username }} -s /bin/bash {{ username }} && \
    echo "{{ username }} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# RÃ©pertoire home initial
RUN chown -R {{ username }}:{{ username }} /home/{{ username }}

# ðŸŸ¢ DÃ©finir TERM pour activer la couleur
ENV TERM=xterm-256color
# ðŸ”¹ DÃ©finir l'environnement X11
ENV DISPLAY=:0
# âœ… DÃ©sactive les erreurs d'accessibilitÃ©
ENV NO_AT_BRIDGE=1
# âœ… Supprime l'erreur de session manager
ENV SESSION_MANAGER=""


# ðŸƒ ExÃ©cuter OpenVPN au dÃ©marrage
# ðŸ”¹ Script de dÃ©marrage pour X11 + OpenVPN + Chrome
CMD openvpn --config /etc/openvpn/{{ username }}.ovpn & \
    sleep 5 && \
    echo -e "nameserver 10.8.0.1\nsearch {{ domain }}" > /etc/resolv.conf && \
    sudo -u {{ username }} bash -c "tail -f /dev/null"

